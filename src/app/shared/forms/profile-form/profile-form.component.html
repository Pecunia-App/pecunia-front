<form [formGroup]="profileForm" (ngSubmit)="onSubmit()" class="profile-card">
  <div class="card-inner">
    <div class="form-header">
      <h2>Profil</h2>
      <div class="top-action">
        @if (!isEditMode) {
          <app-ui-button
            type="button"
            (click)="toggleEditMode()"
            variant="primary"
          >
            Modifier
          </app-ui-button>
        }
      </div>
    </div>

    <div class="card-body">
      <div class="profile-top">
        <div class="avatar-section" role="group" aria-labelledby="avatar-label">
          <div id="avatar-label" class="section-label label-mobile-hidden">
            Photo de profil
          </div>

          <div
            class="avatar-placeholder"
            role="img"
            aria-label="Photo de profil"
          >
            <img
              [src]="avatarSrc"
              alt="Avatar"
              class="avatar-img"
              (error)="setDefaultAvatar()"
            />
          </div>

          <!-- Boutons à droite de l'avatar -->
          @if (isEditMode) {
            <div class="avatar-actions">
              <button
                type="button"
                class="avatar-action-btn avatar-add-btn"
                (click)="openUploadModal()"
                [attr.aria-label]="
                  hasProfilePicture ? 'Modifier la photo' : 'Ajouter une photo'
                "
                [title]="hasProfilePicture ? 'Modifier' : 'Ajouter'"
              >
                <app-ui-icon name="plus"></app-ui-icon>
              </button>

              @if (hasProfilePicture) {
                <button
                  type="button"
                  class="avatar-action-btn avatar-delete-btn"
                  (click)="deleteProfilePicture()"
                  aria-label="Supprimer la photo"
                  title="Supprimer"
                >
                  <app-ui-icon name="trash-2"></app-ui-icon>
                </button>
              }

              <input
                #fileInput
                type="file"
                accept="image/png,image/jpeg"
                (change)="onFileSelected($event)"
                hidden
              />
            </div>
          }
        </div>

        <div
          class="appearance-area"
          role="group"
          aria-labelledby="appearance-label"
        >
          <div id="appearance-label" class="section-label label-mobile-hidden">
            Apparence
          </div>
          <app-theme-switch></app-theme-switch>
        </div>
      </div>

      <div class="form-group">
        <app-ui-input
          label="Prénom"
          formControlName="firstname"
          placeholder="Votre prénom"
          [readonly]="!isEditMode"
          type="text"
        >
          <app-ui-icon name="user" icon-left></app-ui-icon>
        </app-ui-input>

        <app-ui-input
          label="Nom"
          formControlName="lastname"
          placeholder="Votre nom"
          [readonly]="!isEditMode"
          type="text"
        >
          <app-ui-icon name="user" icon-left></app-ui-icon>
        </app-ui-input>

        <app-ui-input
          label="Email"
          formControlName="email"
          placeholder="Votre email"
          type="email"
          [readonly]="!isEditMode"
        >
          <app-ui-icon name="mail" icon-left></app-ui-icon>
        </app-ui-input>

        @if (!isEditMode) {
          <app-ui-input
            label="Mot de passe"
            [value]="'••••••••••••'"
            [readonly]="true"
            type="password"
            class="password-display"
          >
            <app-ui-icon name="lock" icon-left></app-ui-icon>
          </app-ui-input>
        }
      </div>

      @if (isEditMode) {
        <div class="password-fields">
          <app-ui-input
            label="Mot de passe"
            formControlName="password"
            [type]="showPassword ? 'text' : 'password'"
            placeholder="Votre nouveau mot de passe"
          >
            <app-ui-icon name="lock" icon-left></app-ui-icon>
          </app-ui-input>

          <app-ui-input
            label="Confirmer le mot de passe"
            formControlName="confirmPassword"
            [type]="showPassword ? 'text' : 'password'"
            placeholder="Confirmez votre mot de passe"
          >
            <app-ui-icon name="lock" icon-left></app-ui-icon>
          </app-ui-input>

          <div class="show-password">
            <input
              type="checkbox"
              id="showPassword"
              (change)="togglePasswordVisibility()"
            />
            <label for="showPassword">Afficher le mot de passe</label>
          </div>
        </div>
      }

      @if (isEditMode) {
        <div class="form-actions">
          <app-ui-button
            type="submit"
            [disabled]="!profileForm.valid || profileForm.pristine"
            variant="primary"
          >
            Valider
          </app-ui-button>
          <app-ui-button
            type="button"
            (click)="toggleEditMode()"
            variant="alert"
          >
            Annuler
          </app-ui-button>
        </div>
      }
    </div>
  </div>
</form>

<!-- Modal d'upload -->
@if (showUploadModal) {
  <div class="avatar-modal-backdrop">
    <div class="avatar-modal">
      <h3>Ajouter une photo</h3>

      <div class="avatar-modal-preview" role="img" aria-label="Aperçu photo">
        @if (uploadPreview) {
          <img [src]="uploadPreview" alt="Aperçu" />
        } @else {
          <img src="assets/images/downloadProfilPicture.png" alt="Aperçu" />
        }
      </div>

      <!-- Bouton download visible uniquement si aucune image sélectionnée -->
      @if (!uploadPreview) {
        <div class="avatar-modal-actions">
          <app-ui-button
            type="button"
            (click)="openFilePicker()"
            variant="primary"
            aria-label="Télécharger une photo"
          >
            <app-ui-icon name="arrow-down-to-line"></app-ui-icon>
          </app-ui-button>

          <app-ui-button type="button" variant="alert" (click)="cancelUpload()">
            Annuler
          </app-ui-button>
        </div>
      }

      <!-- Boutons d'action visibles uniquement si une image est sélectionnée -->
      @if (uploadPreview) {
        <div class="avatar-modal-actions">
          <app-ui-button
            variant="primary"
            type="button"
            (click)="confirmUpload()"
            [disabled]="!uploadPreview"
          >
            Valider
          </app-ui-button>
          <app-ui-button variant="alert" type="button" (click)="cancelUpload()">
            Annuler
          </app-ui-button>
        </div>
      }

      <!-- Input file caché -->
      <input
        #fileInput
        type="file"
        accept="image/png,image/jpeg"
        (change)="onFileSelected($event)"
        hidden
      />
    </div>
  </div>
}
